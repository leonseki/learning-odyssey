---
title: 锁系列 02 - Java对象的结构
date: 2024-02-21
slug: lock/object-structure
image: img/2024/02/JaneAusten.jpg
categories: [Learning]
tags: [Learning, lock]
---


## 对象结构

Java对象的结构指的是一个Java对象在内存中的组织方式。在Java中，每个对象都有三个主要部分构成：

* **对象头（Object Header）**：对象头是对象在内存中的元数据，包含了一些重要的信息，比如对象的哈希码、对象的锁状态、对象的GC信息等。
* **实例数据（Instance Data）**：实例数据是对象的实际内容，即对象的属性值。这些数据根据对象所属的类的定义而定，它们存储着对象的状态信息。
* **填充（Padding）**：填充用于对齐对象的起始地址，以提高内存访问效率。Java对象的起始地址通常需要对齐到某个特定的边界，填充可以确保对象的起始地址满足对齐要求。

![](img/2024/02/object-structure.png)


## 对象头
对象头是和Java **Synchronized**关键字密切相关的，下面重点介绍一下：

Java对象头是Java对象在内存中的元数据，它包含了一些重要的信息，主要用于支持Java虚拟机（JVM）的运行时数据结构和垃圾回收。Java对象头通常包括三个部分：**标记字（Mark Word）**，**类型指针（Type Pointer）**和**数组长度（Array Length）**。

### 标记字（Mark Word）
标记字是对象头中最重要的部分之一，它包含了一些标记信息，比如对象的锁状态、GC信息等。标记字的具体结构在不同的JVM实现中可能会有所不同，但它通常至少包含对象的哈希码、分代年龄、锁状态等信息。**当对象处于不同的锁状态时，它的Mark Word里的数据会被替换**。下面是64位虚拟机示例图：
![](img/2024/02/markword.png)
* **identity_hashcode**：**31位**的对象标识hashCode，是对象在内存中的唯一标识，用于在哈希表等数据结构中快速查找对象。
* **age**：**4位**的分代年龄用于支持分代垃圾回收算法，它表示对象在内存中存在的时间长短。
* **biased_lock**：**1位**的偏向锁标记，表示对象是否启用偏向锁。
* **lock**：**2位**的锁状态标记位。
  * 00：无锁状态
  * 01：偏向锁状态
  * 10：轻量级锁状态
  * 11：重量级锁状态
* **thread**：**54位**的持有偏向锁的线程ID。
* **epoch**：**2位**的偏向锁的时间戳。
* **ptr_to_lock_record**：**62位**，轻量级锁状态下，指向栈中锁记录的指针。
* **ptr_to_heavyweight_monitor**：**62位**重量级锁状态下，指向对象监视器Monitor的指针。


### 类型指针（Type Pointer）
类型指针指向对象的类元数据（Class Metadata），用于确定对象所属的类以及访问类相关信息。这使得JVM可以在运行时动态地确定对象的类型，并调用正确的方法。

### **数组长度（Array Length）**
如果对象是数组类型，对象头中可能还包含数组的长度信息，用于记录数组的大小。